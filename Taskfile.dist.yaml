# See <https://taskfile.dev/usage> and <https://taskfile.dev/reference/schema>
# to find all keys and their usage.
version: "3"

silent: true
env:
  SELF: "task {{ .ALIAS | default .TASK }} --"

tasks:
  release:
    desc: Release a new version.
    cmd: ./scripts/release {{ .CLI_ARGS }}

  update:plugins:
    desc: Update Prosody community modules
    cmds:
      - hg -R plugins/community pull --update
      - git add plugins/community
      - "git commit -m 'feat(prosody): Update Prosody Community modules'"
    preconditions:
      - git diff --cached --quiet

  dev:build:
    desc: Build `proseim/prose-pod-server:local`
    cmd: |-
      docker build -t proseim/prose-pod-server:local \
        --build-arg VERSION="$(cat VERSION)" \
        --build-arg COMMIT="$(git rev-parse HEAD)" \
        '{{ .ROOT_DIR }}'
    sources:
      - plugins/**
      - prosody/**
      - api/src/**
      - api/Cargo.toml
      - pod-bootstrap.cfg.lua
      - VERSION
      - Dockerfile
      - .dockerignore

  internal:
    cmds:
      - pushd plugins/community
      - hg init
      - hg pull https://hg.prosody.im/prosody-modules/
      - popd
