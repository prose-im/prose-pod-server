# HG changeset patch
# User RÃ©mi Bardon <remi@remibardon.name>
# Date 1762249606 -28800
#      Tue Nov 04 17:46:46 2025 +0800
# Node ID 2d3c5aad5b534413bf84f8f41dfd0a13b48ee437
# Parent  c69edc9c19fff24752086dba7cfeb30f289b2165
mod_http_oauth2: Coerce net.http errors more consistently

diff -r c69edc9c19ff -r 2d3c5aad5b53 mod_rest/mod_rest.lua
--- a/mod_rest/mod_rest.lua	Mon Nov 03 15:32:36 2025 +0800
+++ b/mod_rest/mod_rest.lua	Tue Nov 04 17:46:46 2025 +0800
@@ -6,6 +6,7 @@
 
 local encodings = require "util.encodings";
 local base64 = encodings.base64;
+local code2err = require "net.http.errors".registry;
 local errors = require "util.error";
 local http = require "net.http";
 local id = require "util.id";
@@ -532,8 +533,6 @@
 			end
 		end);
 
-	local code2err = require "net.http.errors".registry;
-
 	local function handle_stanza(event)
 		local stanza, origin = event.stanza, event.origin;
 		local reply_allowed = stanza.attr.type ~= "error" and stanza.attr.type ~= "result";
@@ -685,6 +684,11 @@
 module:hook_object_event(http_server, "http-error", function (event)
 	local request, response = event.request, event.response;
 	local response_as = decide_type(request and request.headers.accept or "", supported_errors);
+
+	if not event.error and code2err[event.code] then
+		event.error = errors.new(event.code, nil, code2err);
+	end
+
 	if response_as == "application/xmpp+xml" then
 		if response then
 			response.headers.content_type = "application/xmpp+xml";
